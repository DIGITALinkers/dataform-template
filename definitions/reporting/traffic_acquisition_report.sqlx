config {
  type: "table",
  schema: "reporting",
  name: "traffic_acquisition_report"
}

SELECT
  channel_group,
  COUNT(DISTINCT unique_session_id) AS sessions,
  COUNT(DISTINCT user_pseudo_id) AS users,
  SUM(has_purchase) AS purchases,
  SAFE_DIVIDE(SUM(has_purchase), COUNT(DISTINCT unique_session_id)) AS conversion_rate,
  SAFE_DIVIDE(SUM(has_purchase), COUNT(DISTINCT user_pseudo_id)) AS user_conversion_rate
FROM ${ref("session_flags")}
GROUP BY channel_group
ORDER BY sessions DESC
